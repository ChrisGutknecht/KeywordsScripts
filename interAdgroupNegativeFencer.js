/************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/


/* norisk DANGER ZONE: You have taken this too far.

- If you tried to log this into the Ads Scripts console, it's not going to work with the 100k char logger limit
- If you managed to log this into to the browser (good job finding the UserAgent), the core business logic is uglified and impossible to reverse engineer

NOTE: This specific request is logged via Google Analytics including the AdWords account ID and will trigger an alert on behalf of norisk. 




                            uuuuuuu
                         uu$$$$$$$$$$$uu
                      uu$$$$$$$$$$$$$$$$$uu
                     u$$$$$$$$$$$$$$$$$$$$$u
                    u$$$$$$$$$$$$$$$$$$$$$$$u
                   u$$$$$$$$$$$$$$$$$$$$$$$$$u
                   u$$$$$$$$$$$$$$$$$$$$$$$$$u
                   u$$$$$$"   "$$$"   "$$$$$$u
                   "$$$$"      u$u       $$$$"
                    $$$u       u$u       u$$$
                    $$$u      u$$$u      u$$$
                     "$$$$uu$$$   $$$uu$$$$"
                      "$$$$$$$"   "$$$$$$$"
                        u$$$$$$$u$$$$$$$u
                         u$"$"$"$"$"$"$u
              uuu        $$u$ $ $ $ $u$$       uuu
             u$$$$        $$$$$u$u$u$$$       u$$$$
              $$$$$uu      "$$$$$$$$$"     uu$$$$$$
            u$$$$$$$$$$$uu    """""    uuuu$$$$$$$$$$
            $$$$"""$$$$$$$$$$uuu   uu$$$$$$$$$"""$$$"
             """      ""$$$$$$$$$$$uu ""$"""
                       uuuu ""$$$$$$$$$$uuu
              u$$$uuu$$$$$$$$$uu ""$$$$$$$$$$$uuu$$$
              $$$$$$$$$$""""           ""$$$$$$$$$$$"
               "$$$$$"                      ""$$$$""
                 $$$"                         $$$$"


/************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/

/****************************************************/
/************* GLOBAL CONSTANTS *********************/
/****************************************************/

var allNegativesList = [];
var entityIdLookupObject = {};
var checkGenericCache = {};
var TOO_GENERIC_MIN_COUNT = {"campaign" : 10000, "keyword" : 1000000}; // Set very high because not used anymore
var impactSummary = [["Campaign","AdGroup", "keyword", "Query", "NewNegatives", "expectedClickLoss (ref:" + DATE_RANGE + ")", "CaseInfo", "TimeStamp"]];
var skipped_MaxClick_Summary = [["Campaign","AdGroup", "keyword",  "Query", "SkippedNegatives", "expectedClickLoss (ref:" + DATE_RANGE + ")", "CaseInfo", "TimeStamp"]];
var skipped_Generic_Summary = [["Campaign","AdGroup", "keyword",  "Query", "SkippedNegatives", "expectedClickLoss (ref:" + DATE_RANGE + ")", "GenericData", "CaseInfo", "TimeStamp"]];
var skipLimit_MinCount = {}; // 
var skipped_MaxClick_negatives = [];
var TIME_STAMP = getTimeStamp();
var AG_CHECK_LABEL;
var MAX_QUERY_CLICKS_FOR_NEGATIVE_AUTO_FENCING = 100000000; // Set very high because not used anymore
var MIN_IMP_FOR_REFERENCE_QUERY = MIN_IMP_FOR_REFERENCE_KEYWORD;

/***************************************************/
/*********** START MAIN BUSINESS LOGIC  ************/
/***************************************************/


function interAdgroupNegativeFencer() {
  
  Logger.log("QueryOverlap from " + DATE_RANGE + " and clicks >= " + MIN_CLICKS_SOURCE_KEYWORD);
  AG_CHECK_LABEL = getWeekLabel();
  
  createLabel(AG_CHECK_LABEL);
  
  /*var adGroupIterator = getAdGroupIterator();
  while(adGroupIterator.totalNumEntities === 0){
    if(MIN_CLICKS_SOURCE_KEYWORD === 2) continue;
    if(MIN_CLICKS_SOURCE_KEYWORD > 0) MIN_CLICKS_SOURCE_KEYWORD--;
    adGroupIterator = getAdGroupIterator();
  }*/

  var adGroupIterator = AdsApp.adGroups()
    .withCondition('Clicks >= ' + MIN_CLICKS_SOURCE_KEYWORD)
    .withCondition('CampaignName CONTAINS_IGNORE_CASE \"' + CAMPAIGN_INCLUDE_STRING_I + '\"')
    .withCondition('CampaignName DOES_NOT_CONTAIN \"' + CAMPAIGN_EXCLUDE_STRING_I + '\"').withCondition('CampaignName DOES_NOT_CONTAIN \"' + CAMPAIGN_EXCLUDE_STRING_II + '\"')
    .withCondition('CampaignName DOES_NOT_CONTAIN \"' + DSA_CAMPAIGN_STRING + '\"').withCondition('CampaignName DOES_NOT_CONTAIN \"' + SHO_CAMPAIGN_STRING + '\"');
  
  // Ignore label filter if needed
  if(typeof IGNORE_WEEK_LABELS !== "undefined" && IGNORE_WEEK_LABELS === 0) adGroupIterator =  adGroupIterator.withCondition('LabelNames CONTAINS_NONE ["' + AG_CHECK_LABEL + '"]');
  adGroupIterator = adGroupIterator.forDateRange(DATE_RANGE).orderBy("Cost DESC").get();
  

  while (adGroupIterator.hasNext()) {
    var adGroup = adGroupIterator.next();
    var adGroupName = adGroup.getName();
    var campaignName = adGroup.getCampaign().getName();

    // 1. get above MaxClick cases first to prevent duplication
    // var relatedQueries_aboveMaxClicks = getRelatedQueries(adGroupName, campaignName, maxClicks);
    
    var relatedQueries = getRelatedQueries(adGroupName, campaignName);

    for(var i=0; i < relatedQueries.length; i++) var queryOverlap = getQueryOverlap(relatedQueries[i]);
    setCheckLabelToAdGroup(adGroup);
      
    // Limit number of adgroup iterations by execution time
    var minutesRemaining = AdWordsApp.getExecutionInfo().getRemainingTime()/60;
    if (minutesRemaining < 5) {Logger.log("Execution time past twentyfive minutes. Stopping execution..."); break;}
  
  } // END Adgroup While Loop 

  Logger.log("\n******\nFinished collecting overlaps for adGroups without currentWeek_CheckLabel. Sending email if observations were found. If you wish to see all results, set the variable as follows: var IGNORE_WEEK_LABELS = 0.  Have a nice Ads day!\n******");

  impactSummary = addSumRowToSummary(impactSummary);
  skipped_MaxClick_Summary = addSumRowToSummary(skipped_MaxClick_Summary);
  skipped_Generic_Summary = addSumRowToSummary(skipped_Generic_Summary);
  
  // if(DEBUG_MODE === 1 && SET_NEGATIVES === 1) Logger.log("entityIdLookupObject : " + JSON.stringify(entityIdLookupObject));

  if(impactSummary.length > 2 || skipped_MaxClick_Summary.length > 2 ||skipped_Generic_Summary.length > 2) {

    // Send Email Notification
    sendNotificationEmail(impactSummary,entityIdLookupObject, skipped_MaxClick_Summary, skipped_Generic_Summary);
    removeOldAndUsedWeekLabels();

    // Print Data to Sheet
    /*if(SET_NEGATIVES === 1) printToSheet(impactSummary, "1. CREATED");
    if(SET_NEGATIVES === 0) printToSheet(impactSummary, "2. PREVIEW");
    printToSheet(skipped_MaxClick_Summary, "3. Skipped_MaxClicks");
    printToSheet(skipped_Generic_Summary, "4. Skipped_TooGeneric");*/
  }
}




////////////////////////////////////
////////////////////////////////////
////// FUNCTION DEFINITIONS/////////
////////////////////////////////////
////////////////////////////////////

/* CASES if query differs, 
1. Early Return: pass exact query to keywordSelector.
2. Pass query to query report, if found in other adgroups. If triggerKeyword closer to query, set negative in source
*/


function getRelatedQueries(adGroup, campaign) {
  var queries = [], sqReport;

  try {
    var selectQuery =
        'SELECT Query,KeywordTextMatchingQuery,QueryMatchTypeWithVariant,CampaignName,AdGroupName,Clicks,Cost,Ctr,Conversions,CostPerConversion,ConversionValue,AverageCpc ' +
        'FROM SEARCH_QUERY_PERFORMANCE_REPORT ' +
        'WHERE Clicks >= ' + MIN_CLICKS_SOURCE_KEYWORD + ' AND AdGroupName = \"' + adGroup + '\" AND CampaignName = \"' + campaign + '\" ' +
        'DURING ' + DATE_RANGE;
    
    sqReport = AdWordsApp.report(selectQuery);
  } catch (e) { throw new Error("SearchQuerySelectException: " + e + ". Stacktrace: " + e.stack); }

  var sqReportRows = sqReport.rows();
  try { sqReportRows.next(); } catch (e) {
    return queries;
  }

  try {
    while (sqReportRows.hasNext()) {
      var row = sqReportRows.next();
      var queryString = row["Query"];
      var keyword = row["KeywordTextMatchingQuery"].toLowerCase();
      if (row["Query"] === keyword) continue;
      
      var query = {
        "queryString": queryString,
        "keyword": keyword,
        "matchtype": row["QueryMatchTypeWithVariant"],
        "cpc" : row["AverageCpc"],
        "clicks" : row["Clicks"],
        "conversions" : row["Conversions"],
        "campaign": row["CampaignName"],
        "adgroup": row["AdGroupName"]
      };
      queries.push(query);
    }
  } catch (e) { Logger.log("KeywordLookupException: " + e);}

  if (queries.length > 0) {
    Logger.log("\n*****\nFound " + queries.length + " Queries in AdGroup : " + adGroup + " ( " + campaign + " )\n");
    // if(DEBUG_MODE === 1) Logger.log("Example : " + JSON.stringify(queries[0]) + "\n");
  }
  return queries;
}




function getQueryOverlap(sourceQuery) {

  // if(DEBUG_MODE === 1) Logger.log("\nSearching for query overlap for '" + sourceQuery.queryString + "' , triggered by: " + sourceQuery.keyword);
  var sqReportRows, queryOverlap = {"source" : sourceQuery, "overlapInstances" : []};

  try {
    var selectQuery =
        'SELECT Query,KeywordTextMatchingQuery,QueryMatchTypeWithVariant,CampaignName,CampaignStatus,AdGroupName,AdGroupStatus,Clicks,Cost,Ctr,Conversions,CostPerConversion,ConversionValue,AverageCpc ' +
        'FROM SEARCH_QUERY_PERFORMANCE_REPORT ' +
        'WHERE Query = \"' + sourceQuery.queryString + '\" AND Impressions > ' + MIN_IMP_FOR_REFERENCE_KEYWORD + ' AND AdGroupName DOES_NOT_CONTAIN_IGNORE_CASE \"' + sourceQuery.adgroup + '\" ' +
        'AND CampaignName DOES_NOT_CONTAIN_IGNORE_CASE \"' + SHO_CAMPAIGN_STRING + '\" AND CampaignName DOES_NOT_CONTAIN_IGNORE_CASE "' + DSA_CAMPAIGN_STRING + '" ' +
        'AND CampaignStatus = ENABLED AND CampaignStatus != REMOVED AND AdGroupStatus = ENABLED ' +
        'DURING ' + DATE_RANGE;
    sqReport = AdWordsApp.report(selectQuery);
  } catch (e) {Logger.log("SearchQuerySelectException: " + e); }

  try {
    sqReportRows = sqReport.rows();
    sqReportRows.next();
  } catch (e) { return queryOverlap;}

  try {
    while (sqReportRows.hasNext()) {
      var row = sqReportRows.next();
      var refQueryString = row["Query"];
      var refKeyword = row["KeywordTextMatchingQuery"].toLowerCase().replace(".",""); // .replace(/\+/g,"")
      var overlapInstances = [];
      
      // Calculate wordDistance for source query 
      var levenshteinDistSource = dziemba_levenshtein(sourceQuery.keyword.replace(".","").split(" ").sort().join(","), sourceQuery.queryString.split(" ").sort().join(","));  // .replace(/\+/g,"")
      
      // Edge case: High sim value for keywords without space > update value for distance
      if(sourceQuery.keyword.indexOf(" ") == -1){
        var cleanedKeyword = sourceQuery.keyword.replace(/\+/g,"").replace(".","");
        var queryKw_LengthDiff = sourceQuery.queryString.length - cleanedKeyword.length;
        if(levenshteinDistSource <  queryKw_LengthDiff) levenshteinDistSource =  queryKw_LengthDiff;
      }
      var simValueSource = (1-levenshteinDistSource/sourceQuery.queryString.length).toFixed(2);
      
      sourceQuery.simValue = simValueSource;
      
      // Calculate wordDistance for overlap query
      var levenshteinDist = dziemba_levenshtein(refKeyword.split(" ").sort().join(","), refQueryString.split(" ").sort().join(","));
      var simValue = (1-levenshteinDist/refQueryString.length).toFixed(2);
      
      var singleOverlap = {
        "queryString" : refQueryString,
        "keyword": refKeyword.replace(/\+/g,""),
        "matchtype": row["QueryMatchTypeWithVariant"],
        "simValue" : simValue,
        "cpc" : row["AverageCpc"],
        "clicks" : row["Clicks"],
        "conversions" : row["Conversions"],
        "campaign": row["CampaignName"],
        "adgroup": row["AdGroupName"]
      };

      queryOverlap.overlapInstances.push(singleOverlap);

      if(DEBUG_MODE === 1) Logger.log("\nnegativeSingleOverlap found:\nsourceQuery: " + JSON.stringify(sourceQuery) + "\nreferenceQuery: " + JSON.stringify(singleOverlap));
      
      // Skip if clone campaign case
      if(singleOverlap.campaign !== sourceQuery.campaign && singleOverlap.campaign.replace(CLONE_CAMPAIGN_STRINGS[0],"").replace(CLONE_CAMPAIGN_STRINGS[1],"") === sourceQuery.campaign.replace(CLONE_CAMPAIGN_STRINGS[0],"").replace(CLONE_CAMPAIGN_STRINGS[1],"")) {
        Logger.log("Pseudo-overlap due to clone campaigns detected.");
        return queryOverlap;
      }
      
      var negative, negativeEntry, tooGeneric, negativeMatchType = "phrase";
      singleOverlap.suggestedNegatives = {};
      

      //////////
      //////////
      // CASE 1: Source Query is broader match than reference
      //////////
      //////////
      

      if(sourceQuery.simValue < singleOverlap.simValue) { // (sourceQuery.simValue * 1.02)

        if(DEBUG_MODE === 1) Logger.log("\nOverlap case: source broader");
        negative = determineNegativeKeyword("reference", sourceQuery.keyword, sourceQuery.queryString, singleOverlap.keyword, singleOverlap.queryString);
        var negativeMaxClick_Identifier = sourceQuery.campaign + " |" + sourceQuery.adgroup + " |" + negative;
        tooGeneric = negative.length > 2 ? checkIfNegativeTooGeneric(negative) : 1;
        
        if(tooGeneric == 1) {
          if(negative.length > 2) skipped_Generic_Summary.push([singleOverlap.campaign,singleOverlap.adgroup,singleOverlap.keyword, singleOverlap.queryString, negative, singleOverlap.clicks, JSON.stringify(checkGenericCache[negative]), JSON.stringify(queryOverlap),TIME_STAMP]);
          // Fallback to exact negative
          negative = "[" + sourceQuery.queryString.replace(/\"/g,'') + "]";
          negativeMatchType = "exact";
        }

        /*if(tooGeneric == 0 && negative.length > 2 && sourceQuery.clicks > MAX_QUERY_CLICKS_FOR_NEGATIVE_AUTO_FENCING) {
          skipped_MaxClick_Summary.push([sourceQuery.campaign,sourceQuery.adgroup,sourceQuery.keyword, sourceQuery.queryString, negative, sourceQuery.clicks, JSON.stringify(queryOverlap), TIME_STAMP]);
          skipped_MaxClick_negatives.push(negativeMaxClick_Identifier);
        }*/
        
        negativeEntry = {"_case" : "source", "campaign" : sourceQuery.campaign, "adgroup" : sourceQuery.adgroup, "query" : sourceQuery.queryString, "queryClicks" : sourceQuery.clicks, "keyword" : sourceQuery.keyword, "negative" : negative.trim(), "matchtype" : negativeMatchType};
        

        // Extra logger
        if(DEBUG_MODE === 1) { 
          Logger.log("SourceCase for " + !negative + " Cond NotInNegList: "); Logger.log(allNegativesList.indexOf(JSON.stringify(negativeEntry)) == -1); Logger.log("SourceCase Cond negLength > 2: "); Logger.log(negative.length > 2);
          Logger.log("SourceCase Cond tooGen: "); Logger.log(tooGeneric === 0); Logger.log("SourceCase Cond maxClicks: "); Logger.log(sourceQuery.clicks < MAX_QUERY_CLICKS_FOR_NEGATIVE_AUTO_FENCING); 
        }

        if(allNegativesList.indexOf(JSON.stringify(negativeEntry)) == -1  && negative.length > 2 && checkIfNegativeExists(negativeEntry) === false) {

          queryOverlap.source.suggestedNegatives = negativeEntry;
          
          // Removed conversion conditional : if( (sourceQuery.conversions*0.5 < singleOverlap.conversions) && sourceQuery.conversions < 2.95) {
          Logger.log("Found query overlap for '" + sourceQuery.queryString + "' (keyword " + sourceQuery.keyword +"). Reference case  : " + JSON.stringify(singleOverlap) + "\n");
            
          // Removed set negative command: if(SET_NEGATIVES === 1) { setSingleNegative(negativeEntry); setKeywordLabel("source", sourceQuery, singleOverlap); setKeywordLabel("reference", sourceQuery, singleOverlap);}*/

          allNegativesList.push(JSON.stringify(negativeEntry));
          impactSummary.push([sourceQuery.campaign,sourceQuery.adgroup,sourceQuery.keyword, sourceQuery.queryString, negative, sourceQuery.clicks, JSON.stringify(queryOverlap), TIME_STAMP]);
          // }
        }
      } // END IF Case 1.
      

      //////////
      //////////
      // CASE 2: Reference Query is broader match than source
      //////////
      //////////


      if(sourceQuery.simValue > singleOverlap.simValue) { // (singleOverlap.simValue * 1.02)
        if(DEBUG_MODE === 1) Logger.log("\nOverlap case: reference broader");
        negative = determineNegativeKeyword("reference", singleOverlap.keyword, singleOverlap.queryString, sourceQuery.keyword, sourceQuery.queryString);
        var negativeMaxClick_Identifier = singleOverlap.campaign + " |" + singleOverlap.adgroup + " |" + negative;
        tooGeneric = negative.length > 2 ? checkIfNegativeTooGeneric(negative) : 1;
        
        if(tooGeneric == 1) {
          if(negative.length > 2) skipped_Generic_Summary.push([singleOverlap.campaign,singleOverlap.adgroup,singleOverlap.keyword, singleOverlap.queryString, negative, singleOverlap.clicks, JSON.stringify(checkGenericCache[negative]), JSON.stringify(queryOverlap), TIME_STAMP]);
          // Fallback to exact negative
          negative = "[" + sourceQuery.queryString.replace(/\"/g,'') + "]";
          negativeMatchType = "exact";
        }
        
        /*if(tooGeneric == 0 && negative.length > 2 && singleOverlap.clicks > MAX_QUERY_CLICKS_FOR_NEGATIVE_AUTO_FENCING) {
          skipped_MaxClick_Summary.push([singleOverlap.campaign,singleOverlap.adgroup,singleOverlap.keyword, singleOverlap.queryString, negative, singleOverlap.clicks, JSON.stringify(queryOverlap), TIME_STAMP]);
          skipped_MaxClick_negatives.push(negativeMaxClick_Identifier);
        }*/
        
        negativeEntry = {"_case" : "reference", "campaign" : singleOverlap.campaign, "adgroup" : singleOverlap.adgroup, "query" : singleOverlap.queryString, "queryClicks" : singleOverlap.clicks ,"keyword" : singleOverlap.keyword, "negative" : negative.trim(), "matchtype" : negativeMatchType};
        
        // Extra Logger
        // var conditional = (allNegativesList.indexOf(JSON.stringify(negativeEntry)) == -1 && negative.length > 2 && tooGeneric == 0 && singleOverlap.clicks < MAX_QUERY_CLICKS_FOR_NEGATIVE_AUTO_FENCING);

        if(allNegativesList.indexOf(JSON.stringify(negativeEntry)) == -1 && negative.length > 2 && checkIfNegativeExists(negativeEntry) === false) {

          queryOverlap.overlapInstances.suggestedNegatives = negativeEntry;
            
          // Removed conversion conditional: if( (sourceQuery.conversions > singleOverlap.conversions*0.5)  && singleOverlap.conversions < 3) {
          Logger.log("Found query overlap for '" + sourceQuery.queryString + "' (keyword " + sourceQuery.keyword +"). Reference case  : " + JSON.stringify(singleOverlap));
            
          // Removed set negative command: if(SET_NEGATIVES === 1) { setSingleNegative(negativeEntry); setKeywordLabel("source", singleOverlap, sourceQuery); setKeywordLabel("reference", singleOverlap, sourceQuery); }*/

          allNegativesList.push(JSON.stringify(negativeEntry));
          impactSummary.push([singleOverlap.campaign,singleOverlap.adgroup,singleOverlap.keyword, singleOverlap.queryString, negative, singleOverlap.clicks, JSON.stringify(queryOverlap), TIME_STAMP]);
        }
      } // END IF Case 2. 
    
    } // END While Query Iterator
  } catch (e) { Logger.log("KeywordLookupException: " + e + ". Stacktrace: " + e.stack);}

  // if (queryOverlap.overlapInstances.length > 0) Logger.log("Found queryOverlaps : " + JSON.stringify(queryOverlap));
  return queryOverlap;
}


function dziemba_levenshtein(a, b){
  var tmp;
  if (a.length === 0) { return b.length; }
  if (b.length === 0) { return a.length; }
  if (a.length > b.length) { tmp = a; a = b; b = tmp; }

  var i, j, res, alen = a.length, blen = b.length, row = Array(alen);
  for (i = 0; i <= alen; i++) { row[i] = i; }

  for (i = 1; i <= blen; i++) {
    res = i;
    for (j = 1; j <= alen; j++) {
      tmp = row[j - 1];
      row[j - 1] = res;
      res = b[i - 1] === a[j - 1] ? tmp : Math.min(tmp + 1, Math.min(res + 1, row[j] + 1));
    }
  }
  return res;
}

/*
* @description
* - GOAL: which part of query is not in the source keyword but in the reference keyword ? 
* - SOURCE: "queryString":"new look plus size coats","keyword":"+plussize"
* - REFERENCE: "query":"new look plus size coats","keyword":"coat plus size"
*
* @param {string} negativeCase, sourceKeyword, sourceQuery, referenceKeyword, referenceQuery
* @return {string} negativeKeyword
*/

function determineNegativeKeyword(negativeCase, sourceKeyword, sourceQuery, referenceKeyword, referenceQuery) {
  
  var negativeKeyword = sourceQuery;

  // Currently NOT (!) dependent on negative case, as order of parameters is reversed
  if(sourceQuery.split(" ").length > 1) {
    var sourceQuerySplit = sourceQuery.split(" ");
    for(var i=0; i < sourceQuerySplit.length; i++){
      
      // If source query word is not part of reference keyword AND reference keyword is not part of source query word, then remove
      var referenceKwSplit = referenceKeyword.split(" "), wordsToRemove = [];
      
      for(var j=0; j < referenceKwSplit.length; j++) {
        var wordFromKwInQuery = false;
        if(sourceQuerySplit[i].indexOf(referenceKwSplit[j]) != -1) wordFromKwInQuery = true;
        if(referenceKeyword.indexOf(sourceQuerySplit[i]) == -1 && wordsToRemove.indexOf(sourceQuerySplit[i]) == -1) wordsToRemove.push(sourceQuerySplit[i]);
      }
      
      for (var k=0; k < wordsToRemove.length; k++) negativeKeyword = negativeKeyword.replace(wordsToRemove[k],"");
    
      // If source query word is in source keyword AND in reference keyword, then remove
      if(sourceKeyword.indexOf(sourceQuerySplit[i]) != -1 && referenceKeyword.indexOf(sourceQuerySplit[i]) !== -1) negativeKeyword = negativeKeyword.replace(sourceQuerySplit[i],"").trim();
      negativeKeyword = negativeKeyword.trim();
    }
  }
  
  return '"' + negativeKeyword + '"';
}

/*
* @param {string} negative
* @return {bool} tooGeneric
*/
function checkIfNegativeTooGeneric(negative) {
  
  // Check if generic check result in cache
  if(typeof checkGenericCache[negative] !== "undefined") return checkGenericCache[negative].tooGeneric;

  var tooGeneric = 0, campaignCount = 0, campaignList = [], keywordCount = 0;
  var totalCampaigns = AdWordsApp.campaigns().withCondition("Clicks > 0").forDateRange(DATE_RANGE).orderBy("Clicks").get().totalNumEntities();

  var keywordIterator = AdWordsApp.keywords().withCondition('Text CONTAINS_IGNORE_CASE \"' + negative.replace(/\"/g,'') + '\"').withCondition('Clicks > 0').forDateRange(DATE_RANGE).get();
  keywordCount = keywordIterator.totalNumEntities();
  
  while(keywordIterator.hasNext()) {
    var keyWord = keywordIterator.next();
    if(campaignList.indexOf(keyWord.getCampaign().getName()) == -1) campaignList.push(keyWord.getCampaign().getName());
  }
  campaignCount = campaignList.length;
 
  if(campaignCount > TOO_GENERIC_MIN_COUNT.campaign || keywordCount > TOO_GENERIC_MIN_COUNT.keyword) tooGeneric = 1;
  
  // Push generic check result to cache
  checkGenericCache[negative] = { "tooGeneric": tooGeneric, "campaignCount" : campaignCount, "keywordCount" : keywordCount };
  
  return tooGeneric;
}


/*
* @param {object} negativeObject, consisting of three attributes campaign, adgroup and negative
* @return {bool} negativeExsts
*/
function checkIfNegativeExists(negativeObject){

  var negativeExists = false;

  var adGroupIterator = AdWordsApp.adGroups().withCondition('CampaignName = \"' + negativeObject.campaign + '\"').withCondition('Name = "' + negativeObject.adgroup + '"')  .get();

  if (adGroupIterator.hasNext()) {
    var adGroup = adGroupIterator.next();
    var negativeKeywordIterator = adGroup.negativeKeywords().withCondition('Text = ' + negativeObject.negative).get();
    if(negativeKeywordIterator.totalNumEntities() === 1) negativeExists = true;
  }
  
  return negativeExists;
}


/*
* @param {object} negativeObject, consisting of three attributes campaign, adgroup and negative
* @return {void}
*/
function setSingleNegative(negativeObject){

  var adGroupIterator = AdWordsApp.adGroups()
    .withCondition('CampaignName = \"' + negativeObject.campaign + '\"')
    .withCondition('Name = "' + negativeObject.adgroup + '"')
    .get();

  Logger.log('setSingleNegative : Text = ' + negativeObject.negative);

  if (adGroupIterator.hasNext()) {
    var adGroup = adGroupIterator.next();
    
    var negativeKeywordIterator = adGroup.negativeKeywords().withCondition('Text = ' + negativeObject.negative).get();
    if(negativeKeywordIterator.totalNumEntities() === 0) {
      adGroup.createNegativeKeyword(negativeObject.negative);
      Logger.log("Negative '" + negativeObject.negative + "' added for : " + JSON.stringify(negativeObject));
      
      entityIdLookupObject[adGroup.getCampaign().getName()] = {
        "campId" : adGroup.getCampaign().getId(),
        "adGroups" : {}
      };
      entityIdLookupObject[adGroup.getCampaign().getName()].adGroups[adGroup.getName()] = adGroup.getId();
    }
  }
}


function setKeywordLabel(type, sourceQuery, singleOverlap) {
  var labelName, entity, restrictionLabel = "RestrictedwithNegatives_nrFencer", protectionLabel = "ProtectedFromQueryOverlap_nrFencer";
  
  if(type === "source") {
    createLabel(restrictionLabel);
    entity = sourceQuery;
    labelName = restrictionLabel;
  }
    
  if(type === "reference") {
    createLabel(protectionLabel);
    entity = singleOverlap;
    labelName = protectionLabel;
  }
  
  entity = type === "source" ? sourceQuery : singleOverlap;
  
  var keyWordIterator = AdWordsApp.keywords()
    .withCondition('CampaignName = \"' + entity.campaign + '\"')
    .withCondition('AdGroupName = \"' + entity.adgroup + '\"')
    .withCondition('Text = "' + entity.keyword + '"').get();
  
  if(keyWordIterator.totalNumEntities() === 1) {
    var keyword = keyWordIterator.next();
    keyword.applyLabel(labelName);
  }
  
}


function removeOldAndUsedWeekLabels() {
  var currentCheckLabel = AG_CHECK_LABEL;
  var checkLabelStem = AG_CHECK_LABEL.split("_")[0];
  
  // Removing old labels and removing their associations 
  var labelIterator = AdsApp.labels()
    .withCondition('Name CONTAINS_IGNORE_CASE "' + checkLabelStem + '"')
    .withCondition('Name != "' + currentCheckLabel + '"')
    .get();
  
  while(labelIterator.hasNext()) {
    var label = labelIterator.next();
    var adGroupIterator = label.adGroups().get();
    
    while(adGroupIterator.hasNext()){
      var adGroup = adGroupIterator.next();
      adGroup.removeLabel(label.getName());
    }
    
    if(label.adGroups().get().totalNumEntities() === 0) label.remove();
  }
}



function setCheckLabelToAdGroup(adGroup) {
  var currentCheckLabel = AG_CHECK_LABEL;
  var checkLabelStem = AG_CHECK_LABEL.split("_")[0];
  
  // Removing old labels first
  var labelIterator = adGroup.labels()
    .withCondition('Name CONTAINS_IGNORE_CASE "' + checkLabelStem + '"')
    .withCondition('Name != "' + currentCheckLabel + '"')
    .get();
  
  while(labelIterator.hasNext()) {
    var label = labelIterator.next().getName();
    adGroup.removeLabel(label);
  }
  
  // Adding new week label
  adGroup.applyLabel(currentCheckLabel);

}

function createLabel(name) {
  var labelName = name;
  try {
    var existingLabel = AdWordsApp.labels().withCondition('Name = "' + labelName + '"').get().next();
  } catch (e) { var newLabel = AdWordsApp.createLabel(labelName); }
  return labelName;
}


function getWeekLabel() {
  return "nrQueryOverlapChecked_Week_" + parseInt(new Date().getWeek(),10) + "_Yr_" + parseInt(new Date().getWeekYear(),10).toString();
}

// HELPER FUNCTION FOR LABEL
// Source: https://weeknumber.net/how-to/javascript
// Returns the ISO week of the date.
Date.prototype.getWeek = function() {
  var date = new Date(this.getTime());
  date.setHours(0, 0, 0, 0);
  // Thursday in current week decides the year.
  date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
  // January 4 is always in week 1.
  var week1 = new Date(date.getFullYear(), 0, 4);
  // Adjust to Thursday in week 1 and count number of weeks from date to week1.
  return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
};

// Returns the four-digit year corresponding to the ISO week of the date.
Date.prototype.getWeekYear = function() {
  var date = new Date(this.getTime());
  date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
  return date.getFullYear();
};




function addSumRowToSummary(impactSummary){
  var totalExpectedClickLoss = 0;
  for(var i=1; i<impactSummary.length; i++){
    totalExpectedClickLoss += parseInt(impactSummary[i][5], 10);
  }
  impactSummary.push(["___TOTAL___","___SUM___","___OF___","___EXPECTED___","_CLICK_LOSS_", totalExpectedClickLoss, ""]);
  
  return impactSummary;
}


function sendNotificationEmail(summary, entityIdLookupObject, skippedSummary_maxClicks, skippedSummary) {

  var formattedDate = Utilities.formatDate(new Date(), AdsApp.currentAccount().getTimeZone(), "yyyy-MM-dd'T'HH:mm:ss'Z'");
  var subject = AdWordsApp.currentAccount().getName() + ' |nrInterAdgroup_NegativeFencer Summary for (' + DATE_RANGE + ') | ' + formattedDate;
  var body = subject, htmlOutput;
  
  var htmlBody = '<html><body>Here are the negative fencing results of your last run for date range ' + DATE_RANGE  + ' and <b>min ' + MIN_CLICKS_SOURCE_KEYWORD + '</b> clicks per query<br><br>';
  var executionType = "proposed";
  htmlBody += 'Based on the newly 1. ' + executionType + ' and 2. skipped <b>negative keywords</b>, the EXPECTED CLICK LOSS in the fenced AdGroups is: <b>' + summary[summary.length-1][5] + '</b><br><br>';
  htmlBody += '<br><br><b>*********************************<br><br><b>';
  
  htmlBody += '1. FOUND NEGATIVE KEYWORDS (PREVIEW - NO DEEPLINKS):<br>';
  
  // impact Summary Table
  htmlBody += '<table border="1" width="20%" style="border-collapse:collapse;">';
  htmlBody += '<tr><td align="center"><b>Campaign</b></td>';
  htmlBody += '<td align="center"><b>AdGroup</b></td>';
  htmlBody += '<td align="center"><b>Keyword</b></td>';
  htmlBody += '<td align="center"><b>Query</b></td>';
  htmlBody += '<td align="center"><b>NewNegatives</b></td>';
  htmlBody += '<td align="center"><b>ExpectedClickLoss</b></td>';
  htmlBody += '<td align="center">______________________________<b>OverlapDetails</b>______________________________</td>';
  htmlBody += '<td align="center">   <b>COMMENTS (e.g. for colleagues)</b>   </td></tr>';
 
  for(var i=1; i<summary.length; i++) {
    htmlBody += "<tr>";
    for(var j=0; j<7; j++){
      
      if(j===0 && i !== summary.length-1) {
        // if(SET_NEGATIVES === 1) htmlOutput = '<td><a href="https://ads.google.com/aw/keywords/negative?campaignId=' + entityIdLookupObject[summary[i][j]].campId + '&ocid=' + ACCOUNT_OCID + '">' + summary[i][j] +'</a></td>';
        
        htmlOutput = '<td><a href="https://ads.google.com/aw/keywords/negative?ocid=' + ACCOUNT_OCID + '">' + summary[i][j] +'</a></td>';
        htmlBody += htmlOutput; continue;
      }

      if(j===1 && i !== summary.length-1) {
        // Reference URL: https://ads.google.com/aw/keywords/negative?campaignId=145812224&adGroupId=39303891303&ocid=68525504
        // if(SET_NEGATIVES === 1) htmlOutput = '<td><a href="https://ads.google.com/aw/keywords/negative?campaignId=' + entityIdLookupObject[summary[i][j-1]].campId + '&adGroupId=' + entityIdLookupObject[summary[i][j-1]].adGroups[summary[i][j]] + '&ocid=' + ACCOUNT_OCID + '">' + summary[i][j] +'</a></td>';
        
        htmlOutput = '<td><a href="https://ads.google.com/aw/keywords/negative?ocid=' + ACCOUNT_OCID + '">' + summary[i][j] +'</a></td>';
        htmlBody += htmlOutput; continue;
      }
      if(i === summary.length-1 || j === 5) {
        htmlBody += '<td align="center">'+summary[i][j]+'</td>'; continue;
      }

      if(j === 6) {
        var sourceInfo = summary[i][j].split('simValue')[0].replace('"cpc','<br>"cpc').replace('"campaign','<br>"campaign').replace(/"/g,' ').replace(/\:/g,': ');
        var overlapInfo = summary[i][j].split('overlapInstances')[1].split('suggestedNegatives')[0].replace('"cpc','<br>"cpc').replace('"campaign','<br>"campaign').replace(/"/g,' ').replace(/\:/g,': ');
        htmlBody += '<td style="width:500px"><br>overlap Case:' + overlapInfo.replace("keyword","<b>keyword</b>") + '}<br><br>' + sourceInfo.replace("source","<b>source</b>").replace("keyword","<b>keyword</b>") + '}</td>';

        // Extra cell for comment
        htmlBody += "<td></td>";
      }
      else htmlBody += "<td>"+summary[i][j]+"</td>";

    } // END For loop j (cell)
    htmlBody += "</tr>";
  }
  htmlBody += '<br/><br/></table><br><br><br>';
  
  
  // SkippedSummary_Generic Table
  /*htmlBody += '*********************************<br><br><b>3. SKIPPED NEGATIVES (too generic)<b>:<br><br>';
  htmlBody += '<table border="1" width="20%" style="border-collapse:collapse;">';
  htmlBody += '<tr><td align="center"><b>Campaign</b></td>';
  htmlBody += '<td align="center"><b>AdGroup</b></td>';
  htmlBody += '<td align="center"><b>Keyword</b></td>';
  htmlBody += '<td align="center"><b>Query</b></td>';
  htmlBody += '<td align="center"><b>SkippedNegatives</b></td>';
  htmlBody += '<td align="center"><b>ExpectedClickLoss</b></td>';
  htmlBody += '<td align="center"><b>TooGenericSkipReason</b></td></tr>';
 
  for(i=1; i<skippedSummary.length; i++) {
    htmlBody += "<tr>";
    for(var j=0; j<7; j++){
      if(i === skippedSummary.length-1 || j === 5) {
        htmlBody += '<td align="center">'+skippedSummary[i][j]+'</td>'; continue;
      } else htmlBody += "<td>"+skippedSummary[i][j]+"</td>";
    }
    htmlBody += "</tr>";
  }
  htmlBody += '<br/><br/></table><br><br>';*/
  htmlBody += '<br><br><b>**************** Thanks and Happy Optimizing. Your norisk Team! ****************<br><br><b>';
  htmlBody += '</body></html>';
  
  
  var options = { htmlBody : htmlBody };
  
  for(i in NOTIFY) {
    MailApp.sendEmail(NOTIFY[i], subject, body, options);
    Logger.log("Email sent.");
  }
}
  
  
function printToSheet(impactSummary, targetSheet){
  
  var spreadsheet = SpreadsheetApp.openByUrl(LOG_SHEET_URL);
  var sheet = spreadsheet.getSheetByName(targetSheet);
  
  // Print first row as header
  var headerRange = sheet.getRange(1,1,1,impactSummary[0].length);
  headerRange.setValues([impactSummary[0] ]);
  var lastReportRow = getLastReportRow(sheet);

  var impactSummary_noHeader = impactSummary.slice(1,impactSummary.length-1);
  if(impactSummary_noHeader.length > 0) {
    var cellRange = sheet.getRange(lastReportRow,1,impactSummary_noHeader.length,impactSummary_noHeader[0].length);
    cellRange.setValues(impactSummary_noHeader);
  }
}


function getLastReportRow(spreadsheet) {
  var column = spreadsheet.getRange('A:A');
  var values = column.getValues(); // get all data in one call
  var ct = 0;
  while ( values[ct] && values[ct][0] != "" ) {
    ct++;
  }
  return (ct+1);
}



function getTimeStamp() {

  var currentdate = new Date();
  var currrentHourGmc = currentdate.getUTCHours()+1;
  
  var dateTime =
    (currentdate.getDate() < 10 ? '0' + currentdate.getDate().toString() : currentdate.getDate()) + "." +
    (currentdate.getMonth()+1) + "." +
    currentdate.getFullYear() + " , "  +
    currrentHourGmc + ":"  +
    (currentdate.getMinutes() < 10 ? '0' + currentdate.getMinutes().toString() : currentdate.getMinutes());
   
  return dateTime;  // target format = '24.2.2017 , 12:09'
}





//////////////////////////////
//////////////////////////////
//// UNUSED FUNCTION   
//// var keywordFound = findQueryElsewhereAsKeyword(relatedQueries[i]); if(keywordFound === 1) { /* setNegative(query, keyword, adGroup); continue; */ }
//////////////////////////////
//////////////////////////////


function findQueryElsewhereAsKeyword(query){
  if(DEBUG_MODE === 1) Logger.log("\nLooking up query '" + query.queryString + "' elsewhere as keyword, triggered by: " + query.keyword);
  var queryStringAsExact = "[" + query.queryString + "]"; // 
  var keywordFound = false;
  
  var keywordIterator = AdWordsApp.keywords()
    .withCondition('Text STARTS_WITH_IGNORE_CASE \"' + queryStringAsExact + '\"').withCondition('Impressions > ' + MIN_IMP_FOR_REFERENCE_QUERY)
    .withCondition('AdGroupName != \"' + query.adGroup + '\"')
    .withCondition('CampaignStatus = ENABLED').withCondition('AdGroupStatus = ENABLED').withCondition('Status = ENABLED')
    .forDateRange(DATE_RANGE).orderBy("Impressions DESC").get();
  
  if(keywordIterator.totalNumEntities() > 1) Logger.log("Query " + query.queryString + " found elsewhere as keyword. Count : " + keywordIterator.totalNumEntities());
  
  while (keywordIterator.hasNext()) {
    var keyword = keywordIterator.next();
    var adGroup = keyword.getAdGroup().getName();
    var campaign = keyword.getCampaign().getName();
    var sourceKw = query.keywordTextMatchingQuery.toLowerCase().replace(/\+/g,""), targetKw = keyword.getText().toLowerCase().replace(/\+/g,"");
    
    if (targetKw === sourceKw) {
      Logger.log("CRITICAL: There are two equal keywords in different adGroups:");
      Logger.log("Query trigger : " + query.keywordTextMatchingQuery + " (campaign: " + query.campaign + " | adGroup : " + query.adGroup + ")  VS found keyword : " + keyword + " (campaign: " + campaign + " | adGroup : " + adGroup);
      keywordFound = true;
    }
    if (targetKw === queryStringAsExact) {
      Logger.log("WARNING: A query for your source keyword matches a another exact keyword elsewhere.");
      Logger.log("Query trigger : " + query.keywordTextMatchingQuery + " (campaign: " + query.campaign + " | adGroup : " + query.adGroup + ")  VS found keyword : " + keyword + " (campaign: " + campaign + " | adGroup : " + adGroup);
      keywordFound = true;
    }
   
  }
  return keywordFound;
}